<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 盛夏。大阪行 - v22.0 導覽列修正版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=Zen+Maru+Gothic:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- 視覺核心 (Cinematic Japan) --- */
        :root {
            --primary: #be123c;      /* 茜色 */
            --accent: #d97706;       /* 琥珀 */
            --text-main: #2d2d2d;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body { font-family: 'Zen Maru Gothic', sans-serif; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .serif { font-family: 'Shippori Mincho', serif; }
        .mono { font-family: 'Share Tech Mono', monospace; }
        
        /* 背景：暖色調古都 */
        .bg-cinematic {
            background-image: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        .bg-cinematic::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.85) 60%, rgba(245,245,240,0.95) 100%);
            z-index: -1;
        }

        /* 玻璃擬態 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* 底部導覽列 (v17.1 Style) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: #fdfbf7;
            background-image: radial-gradient(circle at 100% 150%, #fdfbf7 24%, #efebe9 25%, #efebe9 28%, #fdfbf7 29%, #fdfbf7 36%, #efebe9 36%, #efebe9 40%, transparent 40%, transparent),
            radial-gradient(circle at 0    150%, #fdfbf7 24%, #efebe9 25%, #efebe9 28%, #fdfbf7 29%, #fdfbf7 36%, #efebe9 36%, #efebe9 40%, transparent 40%, transparent),
            radial-gradient(circle at 50%  100%, #efebe9 10%, #fdfbf7 11%, #fdfbf7 23%, #efebe9 24%, #efebe9 30%, #fdfbf7 31%, #fdfbf7 43%, #efebe9 44%, #efebe9 50%, #fdfbf7 51%, #fdfbf7 63%, #efebe9 64%, #efebe9 71%, transparent 71%, transparent),
            radial-gradient(circle at 100% 50%, #efebe9 5%, #fdfbf7 6%, #fdfbf7 15%, #efebe9 16%, #efebe9 20%, #fdfbf7 21%, #fdfbf7 30%, #efebe9 31%, #efebe9 35%, #fdfbf7 36%, #fdfbf7 45%, #efebe9 46%, #efebe9 49%, transparent 50%, transparent),
            radial-gradient(circle at 0    50%, #efebe9 5%, #fdfbf7 6%, #fdfbf7 15%, #efebe9 16%, #efebe9 20%, #fdfbf7 21%, #fdfbf7 30%, #efebe9 31%, #efebe9 35%, #fdfbf7 36%, #fdfbf7 45%, #efebe9 46%, #efebe9 49%, transparent 50%, transparent);
            background-size: 20px 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            display: grid; grid-template-columns: repeat(4, 1fr);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 12px 0 8px; color: #a8a29e; transition: all 0.3s;
            border: none; background: none; cursor: pointer; position: relative;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { transform: translateY(-3px); filter: drop-shadow(0 2px 4px rgba(190,18,60,0.2)); }
        .nav-item.active::after {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 40%; height: 3px; background-color: var(--primary); border-radius: 0 0 4px 4px;
        }
        .nav-icon svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-label { font-size: 0.7rem; font-weight: 600; margin-top: 2px; font-family: 'Shippori Mincho', serif; }

        /* 頂部標題列 */
        .top-header {
            position: fixed; top: 0; left: 0; right: 0;
            height: 60px; z-index: 90;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        /* 內容區塊調整 */
        .main-container {
            padding-top: 70px;
            padding-bottom: 90px;
            height: 100vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        /* FAB (+號) - v17.1 Fix */
        .fab { 
            position: fixed; bottom: 6rem; right: 1.25rem; z-index: 80; 
            background-color: var(--primary); color: white; 
            box-shadow: 0 4px 15px rgba(190, 18, 60, 0.4); 
            transition: transform 0.2s; 
            cursor: pointer;
            width: 3.5rem; height: 3.5rem;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.75rem;
        }
        .fab:active { transform: scale(0.9); }

        /* 倒數計時器 (v16.3 Style Restored) */
        .timer-minimal .timer-digit { font-size: 1.5rem; line-height: 1; font-weight: 600; color: var(--primary); }
        .timer-minimal .timer-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em; color: #5f5f5f; }

        /* 現代房卡 */
        .hotel-card-modern {
            background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
            border-radius: 16px; color: #fafaf9; position: relative; overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.1);
        }
        .chip-icon { width: 42px; height: 30px; background: linear-gradient(45deg, #f59e0b, #d97706); border-radius: 6px; }
        
        /* 航班儀表板 */
        .flight-dashboard {
            background-color: #0f172a; color: #fbbf24; font-family: 'Share Tech Mono', monospace;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5); border: 1px solid #334155;
        }
        .flight-row { border-bottom: 1px dashed #334155; }
        .flight-row:last-child { border-bottom: none; }
        
        @keyframes blink-green { 0%, 100% { opacity: 1; text-shadow: 0 0 10px #10b981; } 50% { opacity: 0.5; text-shadow: none; } }
        .status-blink { color: #10b981; animation: blink-green 1.5s infinite; font-weight: bold; }

        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 4px #10b981; }
        .status-offline { background-color: #ef4444; }

        .hover-scale { transition: transform 0.2s; } .hover-scale:hover { transform: scale(1.02); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #edit-modal { transition: opacity 0.3s ease; z-index: 110; }
        #modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: env(safe-area-inset-bottom); }

        .tag { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 999px; font-weight: bold; display: inline-block; margin-right: 4px; }
        .tag-food { background-color: #ffedd5; color: #c2410c; }
        .tag-shop { background-color: #fce7f3; color: #db2777; }
        .tag-spot { background-color: #dbeafe; color: #1d4ed8; }
        .tag-drink { background-color: #fef3c7; color: #b45309; }
    </style>
</head>
<body class="bg-cinematic overflow-hidden">

    <header class="top-header">
        <div class="font-bold text-xl text-rose-700 flex items-center gap-2 serif">
            ⛩️ 盛夏大阪行 
            <span class="text-[10px] bg-stone-100 px-2 py-0.5 rounded-full text-stone-500 mono tracking-widest">v22.0</span>
        </div>
        <span id="connection-status" class="text-[10px] flex items-center px-2 py-1 rounded-full bg-white/80 border border-stone-200 shadow-sm">
            <span class="status-dot status-offline" id="status-dot"></span>
            <span id="status-text" class="text-stone-500 font-bold">Offline</span>
        </span>
    </header>

    <nav class="bottom-nav">
        <button type="button" onclick="switchTab('overview', event)" class="nav-item active" id="btn-overview">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></span>
            <span class="nav-label">行前</span>
        </button>
        <button type="button" onclick="switchTab('itinerary', event)" class="nav-item" id="btn-itinerary">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19 6h-2c0-2.8-2.2-5-5-5S7 3.2 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.7 0 3 1.3 3 3H9c0-1.7 1.3-3 3-3zm7 17H5V8h14v12z"/></svg></span>
            <span class="nav-label">行程</span>
        </button>
        <button type="button" onclick="switchTab('spots', event)" class="nav-item" id="btn-spots">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg></span>
            <span class="nav-label">探索</span>
        </button>
        <button type="button" onclick="switchTab('info', event)" class="nav-item" id="btn-info">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></span>
            <span class="nav-label">資訊</span>
        </button>
    </nav>

    <main class="main-container" id="main-scroll-container">

        <div id="overview-view" class="view-section animate-fade-in">
            <div class="max-w-5xl mx-auto px-4 pb-6 space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-4">
                    <div class="md:flex-1">
                        <div class="inline-block px-3 py-1 rounded-full bg-rose-100 text-rose-700 text-xs font-bold mb-2 tracking-widest">JP TRIP 2026</div>
                        <h2 class="text-3xl md:text-5xl font-bold text-stone-800 serif leading-tight">古都、美食<br>與盛夏的相遇</h2>
                    </div>
                    <div class="glass-card rounded-2xl p-4 w-full md:w-auto min-w-[300px]">
                        <div class="flex justify-between text-center timer-minimal" id="countdown-timer"></div>
                    </div>
                </div>
                <section class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-stone-700 mb-4 flex items-center gap-2 serif border-b border-stone-200 pb-2"><span>📍</span> 旅程亮點</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 rounded-xl bg-white/50 hover-scale"><div class="text-3xl mb-2">🐙</div><div class="font-bold text-lg text-stone-800 mb-1">大阪</div><p class="text-xs text-stone-500 leading-relaxed">熱情奔放的美食之都。新世界懷舊串炸、難波心齋橋的時尚爆買。</p></div>
                        <div class="p-4 rounded-xl bg-white/50 hover-scale"><div class="text-3xl mb-2">🍵</div><div class="font-bold text-lg text-stone-800 mb-1">宇治</div><p class="text-xs text-stone-500 leading-relaxed">抹茶故鄉。平等院的莊嚴、宇治川的寧靜，享受道地抹茶甜點。</p></div>
                        <div class="p-4 rounded-xl bg-white/50 hover-scale"><div class="text-3xl mb-2">🎍</div><div class="font-bold text-lg text-stone-800 mb-1">嵐山</div><p class="text-xs text-stone-500 leading-relaxed">山水交織。竹林小徑的清幽、渡月橋的流水，體驗平安貴族風情。</p></div>
                        <div class="p-4 rounded-xl bg-white/50 hover-scale"><div class="text-3xl mb-2">🦌</div><div class="font-bold text-lg text-stone-800 mb-1">奈良</div><p class="text-xs text-stone-500 leading-relaxed">千年古都。東大寺大佛的震撼與小鹿的互動，獨特歷史韻味。</p></div>
                    </div>
                </section>
                <section class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-stone-700 mb-4 serif border-b border-stone-200 pb-2 flex justify-between items-center">
                        <span>🧳 準備清單</span> <span class="text-xs font-normal text-stone-400 sans-serif">點擊標記完成</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="checklist-container"></div>
                </section>
                <section class="glass-card rounded-2xl p-6 border-l-4 border-l-amber-400">
                    <h3 class="text-lg font-bold text-stone-800 mb-4 serif">💡 旅日重要提醒</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-stone-600">
                        <div class="flex gap-3"><span class="text-xl">💰</span> <div><strong class="block text-stone-800">寺廟參拜零錢</strong> 準備 5円 (結緣) 硬幣。御守、抽籤多只收現金。</div></div>
                        <div class="flex gap-3"><span class="text-xl">📱</span> <div><strong class="block text-stone-800">必備 APP</strong> Visit Japan Web, Google Maps, 乘換案內, Suica。</div></div>
                        <div class="flex gap-3"><span class="text-xl">🌤️</span> <div><strong class="block text-stone-800">6月天氣對策</strong> 梅雨季均溫 24-28°C。必備折傘、好走防水鞋、薄外套。</div></div>
                        <div class="flex gap-3"><span class="text-xl">🛍️</span> <div><strong class="block text-stone-800">退稅規則</strong> 滿 5,500 日圓(含稅)可退稅。消耗品會密封，日本境內不可拆封。</div></div>
                    </div>
                </section>
            </div>
        </div>

        <div id="itinerary-view" class="view-section hidden animate-fade-in">
            <div class="glass-card sticky top-0 z-30 px-2 py-2 mx-2 mb-2 rounded-xl overflow-x-auto no-scrollbar flex gap-2 shrink-0 justify-start md:justify-center bg-white/90 backdrop-blur" id="day-nav"></div>

            <div class="relative pb-4">
                <div class="max-w-4xl mx-auto px-4 pb-2">
                    <div class="glass-card rounded-2xl p-4 flex flex-col md:flex-row justify-between items-center gap-4 text-stone-700">
                        <div class="flex items-center gap-6">
                            <div class="text-center">
                                <div class="text-[10px] text-stone-400 uppercase tracking-wider">Japan Time</div>
                                <div class="text-2xl font-bold mono" id="japan-clock">--:--</div>
                            </div>
                            <div class="h-8 w-px bg-stone-300"></div>
                            <div>
                                <div class="text-[10px] text-stone-400 uppercase">Weather</div>
                                <div class="text-lg font-medium" id="weather-display">--</div>
                            </div>
                        </div>
                        <div class="bg-white/60 rounded-lg px-4 py-2 text-sm w-full md:w-auto border border-stone-100 shadow-sm">
                            <span class="text-rose-600 font-bold mr-2">💡 Tip:</span> <span id="daily-tip" class="text-stone-600">--</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col lg:flex-row max-w-6xl mx-auto gap-4 px-4 mt-2">
                    <div class="flex-1 space-y-3" id="timeline-list"></div>
                    
                    <div class="lg:w-80 shrink-0">
                        <div class="glass-card rounded-xl sticky top-20 overflow-hidden">
                            <div class="p-3 bg-stone-100/50 border-b border-stone-200 flex justify-between items-center">
                                <h3 class="font-bold text-stone-700 text-sm">💴 當日消費</h3>
                                <button type="button" onclick="resetExpenses()" class="text-xs text-stone-400 hover:text-red-500 transition">清除</button>
                            </div>
                            <div class="p-4">
                                <ul id="expense-list" class="space-y-2 mb-4 max-h-[300px] overflow-y-auto text-sm"></ul>
                                <div class="flex justify-between items-center pt-3 border-t border-stone-200/50 mb-3">
                                    <span class="font-bold text-stone-600 text-sm">Total</span>
                                    <span class="font-mono text-xl font-bold text-rose-600" id="expense-total">¥0</span>
                                </div>
                                <form onsubmit="addExpense(event)" class="flex gap-2 mb-2">
                                    <input type="text" id="new-expense-name" placeholder="項目" class="w-full bg-white/80 border border-stone-200 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-rose-400">
                                    <input type="number" id="new-expense-cost" placeholder="¥" class="w-20 bg-white/80 border border-stone-200 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-rose-400">
                                    <button type="submit" class="bg-stone-800 text-white px-3 py-1.5 rounded text-sm hover:bg-black transition">+</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="window.openEditModal()" class="fab">+</button>
            </div>
        </div>

        <div id="spots-view" class="view-section hidden animate-fade-in">
            <div class="max-w-7xl mx-auto px-4 pb-6">
                <div class="sticky top-0 z-20 py-2 bg-transparent">
                    <div class="glass-card rounded-xl p-2 flex flex-wrap gap-2 justify-center">
                        <button type="button" onclick="filterSpots('all')" class="filter-btn active px-4 py-1.5 rounded-lg text-sm font-bold transition bg-stone-800 text-white">全部</button>
                        <button type="button" onclick="filterSpots('Day 1')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 1</button>
                        <button type="button" onclick="filterSpots('Day 2')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 2</button>
                        <button type="button" onclick="filterSpots('Day 3')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 3</button>
                        <button type="button" onclick="filterSpots('Day 4')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 4</button>
                        <button type="button" onclick="filterSpots('Day 5')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 5</button>
                        <button type="button" onclick="filterSpots('Day 6')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 6</button>
                        <button type="button" onclick="filterSpots('Day 7')" class="filter-btn px-4 py-1.5 rounded-lg text-sm font-medium transition text-stone-600 hover:bg-stone-100">Day 7</button>
                    </div>
                </div>
                <div id="spots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-2"></div>
            </div>
        </div>

        <div id="info-view" class="view-section hidden animate-fade-in">
            <div class="max-w-3xl mx-auto px-4 py-8 space-y-8">
                <div class="rounded-xl overflow-hidden shadow-2xl border border-slate-700 bg-slate-900 flight-dashboard">
                    <div class="p-6">
                        <div class="flex justify-between items-end mb-6 border-b border-slate-700 pb-2">
                            <h2 class="text-2xl font-bold text-white tracking-widest mono">FLIGHT BOARD</h2>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                <span class="text-xs text-emerald-400 status-blink">CONFIRMED</span>
                            </div>
                        </div>
                        <div class="flight-row py-4 grid grid-cols-12 gap-2 items-center">
                            <div class="col-span-5 text-white">
                                <div class="text-[9px] text-sky-400">EVA AIR</div>
                                <div class="text-xl font-bold mono">BR148</div>
                            </div>
                            <div class="col-span-3 text-white"><div class="text-[9px] text-slate-500">KHH</div><div class="text-xl font-bold">15:25</div></div>
                            <div class="col-span-1 text-center text-slate-600 text-xl">✈</div>
                            <div class="col-span-3 text-white"><div class="text-[9px] text-slate-500">KIX</div><div class="text-xl font-bold">19:15</div></div>
                            <div class="col-span-12 mt-2 pt-2 border-t border-slate-800 flex justify-between items-center sm:col-span-12"><span class="text-xs text-slate-400">DATE:</span><span class="text-sm text-white font-bold bg-slate-800 px-2 py-0.5 rounded">2026/06/06 (SAT)</span></div>
                        </div>
                        <div class="py-4 grid grid-cols-12 gap-2 items-center">
                            <div class="col-span-5 text-white">
                                <div class="text-[9px] text-sky-400">EVA AIR</div>
                                <div class="text-xl font-bold mono">BR147</div>
                            </div>
                            <div class="col-span-3 text-white"><div class="text-[9px] text-slate-500">KIX</div><div class="text-xl font-bold">20:20</div></div>
                            <div class="col-span-1 text-center text-slate-600 text-xl">✈</div>
                            <div class="col-span-3 text-white"><div class="text-[9px] text-slate-500">KHH</div><div class="text-xl font-bold">22:15</div></div>
                            <div class="col-span-12 mt-2 pt-2 border-t border-slate-800 flex justify-between items-center sm:col-span-12"><span class="text-xs text-slate-400">DATE:</span><span class="text-sm text-white font-bold bg-slate-800 px-2 py-0.5 rounded">2026/06/12 (FRI)</span></div>
                        </div>
                    </div>
                </div>
                <div class="hotel-card-modern p-8">
                    <div class="flex justify-between items-start mb-10 relative z-10">
                        <div class="chip-icon"></div>
                        <div class="text-right text-stone-400"><span class="block text-[10px] tracking-[0.3em] uppercase">Guest Access</span></div>
                    </div>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold text-white tracking-wide mb-1 serif">THE PEAK TSUTENKAKU ELITE</h2>
                        <p class="text-stone-400 text-xs uppercase tracking-widest mb-6">Premium Stay • 6 Nights</p>
                        <div class="grid grid-cols-2 gap-6 text-sm mb-8 pt-6 border-t border-white/10">
                            <div><p class="text-stone-500 text-[10px] uppercase mb-1">Check In</p><p class="font-mono text-white text-base">2026/06/06</p></div>
                            <div><p class="text-stone-500 text-[10px] uppercase mb-1">Check Out</p><p class="font-mono text-white text-base">2026/06/12</p></div>
                            <div class="col-span-2"><p class="text-stone-500 text-[10px] uppercase mb-1">Address</p><p class="text-stone-200 text-sm">1 Chome-7-17 Ebisuhigashi, Naniwa Ward, Osaka, 556-0002日本</p></div>
                            <div class="col-span-2"><p class="text-stone-500 text-[10px] uppercase mb-1">Contact</p><p class="text-stone-200 font-mono">+81 90-4301-7797</p></div>
                            <div class="col-span-2"><p class="text-stone-500 text-[10px] uppercase mb-1">Access</p><p class="text-stone-300 text-xs">惠美須町站 (3號出口) 步行5分 / 新今宮站 步行15分</p></div>
                        </div>
                        <a href="https://www.google.com/maps/search/?api=1&query=The+Peak+Tsutenkaku+Osaka" target="_blank" class="block w-full text-center bg-white text-stone-900 font-bold py-3 rounded-lg hover:bg-stone-200 transition shadow-lg text-sm flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Google Maps 導航
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-black/60 hidden flex items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-sm">
        <div class="glass-card w-full md:w-[500px] rounded-t-2xl md:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full md:translate-y-0 bg-white" id="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-stone-800 serif" id="modal-title">編輯行程</h3>
                <button type="button" onclick="window.closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 text-stone-400 hover:text-stone-600 flex items-center justify-center">✕</button>
            </div>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-stone-400 block mb-1">時間</label><input type="time" id="edit-time" class="w-full bg-stone-50 border-stone-200 rounded-lg p-2"></div>
                    <div><label class="text-xs font-bold text-stone-400 block mb-1">類型</label><select id="edit-type" class="w-full bg-stone-50 border-stone-200 rounded-lg p-2"><option value="spot">⛩️ 景點</option><option value="food">🍽️ 美食</option><option value="shop">🛍️ 購物</option><option value="transport">🚇 交通</option><option value="other">💤 其他</option></select></div>
                </div>
                <div><label class="text-xs font-bold text-stone-400 block mb-1">行程名稱</label><input type="text" id="edit-name" class="w-full bg-stone-50 border-stone-200 rounded-lg font-bold p-2"></div>
                <div><label class="text-xs font-bold text-stone-400 block mb-1">Google Maps 連結</label><input type="url" id="edit-map" class="w-full bg-stone-50 border-stone-200 rounded-lg p-2 text-sm"></div>
                <div><label class="text-xs font-bold text-stone-400 block mb-1">筆記</label><textarea id="edit-desc" rows="3" class="w-full bg-stone-50 border-stone-200 rounded-lg text-sm p-2"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.deleteItem()" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold text-sm hover:bg-red-100">刪除</button>
                    <button type="button" onclick="window.saveItem()" class="flex-[2] bg-stone-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-stone-900 shadow-md">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // v22 Update: Changed storage key to avoid conflict
        const STORAGE_KEY = 'osaka_2026_v22_0_data';

        const firebaseConfig = {
            apiKey: "AIzaSyDsNhFYMVRoDHwtc7Eo5MkCdvHxTNCo82Y",
            authDomain: "jptrip-6ff55.firebaseapp.com",
            projectId: "jptrip-6ff55",
            storageBucket: "jptrip-6ff55.firebasestorage.app",
            messagingSenderId: "211873423886",
            appId: "1:211873423886:web:6b39422ed212004beb525f",
            measurementId: "G-4DEZKCH36B"
        };

        const checklistData = [
            { title: "必備證件", items: ["護照 (效期6個月+)", "Visit Japan Web 截圖", "機票/住宿憑證"] },
            { title: "金錢與網卡", items: ["日幣現金 (千円鈔)", "零錢包", "信用卡", "Suica (Apple Pay)", "網卡/eSIM"] },
            { title: "衣物 (夏季)", items: ["短袖透氣上衣", "薄外套", "好走的鞋", "吸濕排汗內著"] },
            { title: "必備 APP", items: ["Visit Japan Web", "Google Maps", "乘換案內", "Suica App", "VoiceTra"] },
            { title: "生活用品", items: ["折疊傘", "行動電源", "常備藥品", "手持風扇/涼感紙巾", "環保袋"] }
        ];

        const defaultTripData = {
            "2026-06-06": { dateDisplay: "06/06 (六)", weather: "☁️ 25°C", tip: "入境請準備 VJW，搭南海電鐵。", items: [{id:"d1-1", time:"15:25", title:"BR148 起飛", type:"transport", mapUrl:"", desc:"高雄 KHH -> 大阪 KIX"},{id:"d1-2", time:"19:15", title:"抵達關西機場 T1", type:"transport", mapUrl:"", desc:"入境審查約 30-60 分鐘"},{id:"d1-3", time:"20:30", title:"搭南海電鐵", type:"transport", mapUrl:"", desc:"機場急行 -> 新今宮"},{id:"d1-4", time:"22:00", title:"民宿 Check-in", type:"other", mapUrl:"https://www.google.com/maps/search/?api=1&query=The+Peak+Tsutenkaku", desc:"The Peak Tsutenkaku"},{id:"d1-5", time:"22:30", title:"串炸弁慶", type:"food", mapUrl:"", desc:"通天閣旁宵夜"}], expenses: [] },
            "2026-06-07": { dateDisplay: "06/07 (日)", weather: "☀️ 27°C", tip: "天神橋筋很長，穿好走的鞋。", items: [{id:"d2-1", time:"09:30", title:"猿田彥珈琲", type:"food", mapUrl:"", desc:"北濱河岸早餐"},{id:"d2-2", time:"10:30", title:"中之島玫瑰園", type:"spot", mapUrl:"", desc:"河岸散步"},{id:"d2-3", time:"11:00", title:"大阪天滿宮", type:"spot", mapUrl:"", desc:"學問之神"},{id:"d2-4", time:"11:30", title:"天神橋筋商店街", type:"shop", mapUrl:"", desc:"日本最長商店街"},{id:"d2-5", time:"13:00", title:"肉屋金星", type:"food", mapUrl:"", desc:"高CP值燒肉"},{id:"d2-6", time:"15:00", title:"西洋茶館", type:"food", mapUrl:"", desc:"英式下午茶"}], expenses: [] },
            "2026-06-08": { dateDisplay: "06/08 (一)", weather: "☁️ 26°C", tip: "勝尾寺公車班次少，注意時間。", items: [{id:"d3-1", time:"08:00", title:"前往勝尾寺", type:"transport", mapUrl:"", desc:"御堂筋線 -> 箕面萱野 + 公車"},{id:"d3-2", time:"09:30", title:"勝尾寺", type:"spot", mapUrl:"", desc:"滿山達摩"},{id:"d3-3", time:"13:00", title:"中崎町散策", type:"spot", mapUrl:"", desc:"古民家咖啡、古著店"},{id:"d3-4", time:"16:00", title:"梅田購物", type:"shop", mapUrl:"", desc:"阪急百貨、LUCUA"},{id:"d3-5", time:"19:00", title:"Hanadako 章魚燒", type:"food", mapUrl:"", desc:"新梅田食道街"}], expenses: [] },
            "2026-06-09": { dateDisplay: "06/09 (二)", weather: "☀️ 28°C", tip: "鹿會搶食，注意隨身財物。", items: [{id:"d4-1", time:"08:00", title:"前往宇治", type:"transport", mapUrl:"", desc:"京阪電鐵"},{id:"d4-2", time:"10:00", title:"宇治抹茶巡禮", type:"food", mapUrl:"", desc:"伊藤久右衛門 / 中村藤吉"},{id:"d4-3", time:"11:30", title:"平等院", type:"spot", mapUrl:"", desc:"鳳凰堂"},{id:"d4-4", time:"15:00", title:"前往奈良", type:"transport", mapUrl:"", desc:"JR奈良線"},{id:"d4-5", time:"15:30", title:"奈良公園 & 東大寺", type:"spot", mapUrl:"", desc:"餵鹿、看大佛"},{id:"d4-6", time:"19:00", title:"元喜神拉麵", type:"food", mapUrl:"", desc:"雞白湯+雜炊"}], expenses: [] },
            "2026-06-10": { dateDisplay: "06/10 (三)", weather: "⛅ 25°C", tip: "嵐山遊客多，早點出發。", items: [{id:"d5-1", time:"09:00", title:"前往嵐山", type:"transport", mapUrl:"", desc:"阪急電鐵"},{id:"d5-2", time:"10:30", title:"竹林小徑 & 渡月橋", type:"spot", mapUrl:"", desc:"經典地標"},{id:"d5-3", time:"11:30", title:"% ARABICA", type:"food", mapUrl:"", desc:"河畔拿鐵"},{id:"d5-4", time:"12:30", title:"廣川鰻魚飯", type:"food", mapUrl:"", desc:"米其林一星"},{id:"d5-5", time:"19:00", title:"串炸弁慶", type:"food", mapUrl:"", desc:"回新世界晚餐"},{id:"d5-6", time:"20:30", title:"MEGA唐吉軻德", type:"shop", mapUrl:"", desc:"新世界店補貨"}], expenses: [] },
            "2026-06-11": { dateDisplay: "06/11 (四)", weather: "☀️ 27°C", tip: "木津市場建議中午前抵達。", items: [{id:"d6-1", time:"09:00", title:"木津市場", type:"food", mapUrl:"", desc:"海鮮丼、水果"},{id:"d6-2", time:"10:30", title:"難波八阪神社", type:"spot", mapUrl:"", desc:"巨大獅子殿"},{id:"d6-3", time:"11:30", title:"HARBS", type:"food", mapUrl:"", desc:"Namba Parks 水果千層"},{id:"d6-4", time:"13:00", title:"難波/心齋橋", type:"shop", mapUrl:"", desc:"無印良品、Uniqlo"},{id:"d6-5", time:"21:00", title:"一蘭拉麵", type:"food", mapUrl:"", desc:"道頓堀店宵夜"}], expenses: [] },
            "2026-06-12": { dateDisplay: "06/12 (五)", weather: "☀️ 28°C", tip: "Outlet 有大型寄物櫃。", items: [{id:"d7-1", time:"11:00", title:"退房", type:"other", mapUrl:"", desc:"前往天下茶屋轉乘"},{id:"d7-2", time:"13:00", title:"臨空城 Outlet", type:"shop", mapUrl:"", desc:"最後血拼"},{id:"d7-3", time:"13:30", title:"Panda Express", type:"food", mapUrl:"", desc:"午餐"},{id:"d7-4", time:"15:30", title:"機場 Check-in", type:"transport", mapUrl:"", desc:"BR147"},{id:"d7-5", time:"17:30", title:"神座拉麵", type:"food", mapUrl:"", desc:"機場 3F 晚餐"},{id:"d7-6", time:"20:20", title:"起飛", type:"transport", mapUrl:"", desc:"BR147 -> KHH"}], expenses: [] }
        };

        const allSpots = [
            // Day 1
            { day: "Day 1", type: "food", name: "551蓬萊肉包", tag: "晚餐", desc: "關西機場2F" },
            { day: "Day 1", type: "food", name: "神座拉麵", tag: "晚餐", desc: "關西機場2F" },
            { day: "Day 1", type: "food", name: "串炸弁慶", tag: "宵夜", desc: "通天閣旁，禁止二次沾醬" },
            { day: "Day 1", type: "food", name: "鶴橋男串", tag: "宵夜", desc: "新今宮，烤串" },
            { day: "Day 1", type: "shopping", name: "MEGA唐吉軻德", tag: "購物", desc: "新世界店" },

            // Day 2
            { day: "Day 2", type: "food", name: "猿田彥珈琲", tag: "早餐", desc: "淀屋橋店，有烤箱" },
            { day: "Day 2", type: "food", name: "Sandwich Parlour 47", tag: "早餐", desc: "河景三明治" },
            { day: "Day 2", type: "food", name: "Brooklyn Roasting", tag: "早餐", desc: "河畔戶外座位" },
            { day: "Day 2", type: "attraction", name: "中之島玫瑰園", tag: "景點", desc: "河岸散步" },
            { day: "Day 2", type: "attraction", name: "大阪天滿宮", tag: "景點", desc: "學問之神" },
            { day: "Day 2", type: "shopping", name: "天神橋筋商店街", tag: "購物", desc: "日本最長商店街" },
            { day: "Day 2", type: "food", name: "Maruyama Crêpe", tag: "甜點", desc: "料多可麗餅" },
            { day: "Day 2", type: "food", name: "Ogimachi Udon-ya", tag: "午餐", desc: "咖哩烏龍麵" },
            { day: "Day 2", type: "food", name: "Hara Donuts", tag: "甜點", desc: "豆乳甜甜圈" },
            { day: "Day 2", type: "food", name: "Abeno Dango", tag: "甜點", desc: "黃豆粉糰子" },
            { day: "Day 2", type: "food", name: "西洋茶館", tag: "午茶", desc: "手工布丁" },
            { day: "Day 2", type: "food", name: "章魚燒道樂 Wanaka", tag: "小吃", desc: "外脆內軟" },
            { day: "Day 2", type: "food", name: "肉屋金星", tag: "午餐", desc: "高CP值燒肉" },
            { day: "Day 2", type: "food", name: "Le Croissant", tag: "甜點", desc: "迷你可頌" },
            { day: "Day 2", type: "food", name: "揚揚麻拉麵", tag: "午餐", desc: "擔擔麵" },
            { day: "Day 2", type: "food", name: "うまい屋", tag: "小吃", desc: "米其林章魚燒" },
            { day: "Day 2", type: "food", name: "前田豆腐布丁", tag: "甜點", desc: "豆乳布丁" },
            { day: "Day 2", type: "shopping", name: "天神橋扭蛋店", tag: "購物", desc: "四丁目" },
            { day: "Day 2", type: "food", name: "Saude", tag: "小吃", desc: "巴西莓水果碗" },

            // Day 3
            { day: "Day 3", type: "food", name: "麥當勞通天閣店", tag: "早餐", desc: "鬆餅堡" },
            { day: "Day 3", type: "attraction", name: "勝尾寺", tag: "景點", desc: "祈求勝運達摩" },
            { day: "Day 3", type: "food", name: "Bull Pulu", tag: "小吃", desc: "箕面Q's Mall 飲品" },
            { day: "Day 3", type: "shopping", name: "C-pla 扭蛋", tag: "購物", desc: "箕面Q's Mall" },
            { day: "Day 3", type: "shopping", name: "無印良品", tag: "購物", desc: "箕面Q's Mall" },
            { day: "Day 3", type: "food", name: "Sunny Side", tag: "小吃", desc: "咖哩麵包" },
            { day: "Day 3", type: "food", name: "TruffleBAKERY", tag: "甜點", desc: "白松露鹽可頌" },
            { day: "Day 3", type: "food", name: "Onigiri Gorichan", tag: "午餐", desc: "飯糰茶泡飯" },
            { day: "Day 3", type: "food", name: "Musubido", tag: "午餐", desc: "飯糰定食" },
            { day: "Day 3", type: "food", name: "Aoyama", tag: "午餐", desc: "壽司" },
            { day: "Day 3", type: "food", name: "soba MAREN", tag: "午餐", desc: "雞肉紫蘇油麵" },
            { day: "Day 3", type: "food", name: "拉麵 菊半", tag: "午餐", desc: "雞豬豚骨湯頭" },
            { day: "Day 3", type: "food", name: "山辰", tag: "小吃", desc: "炸牛排/豬排" },
            { day: "Day 3", type: "food", name: "太陽之塔", tag: "小吃", desc: "懷舊咖啡廳" },
            { day: "Day 3", type: "shopping", name: "ONLY PLANET", tag: "購物", desc: "動物雜貨" },
            { day: "Day 3", type: "shopping", name: "Pigsty / Green Pepe", tag: "購物", desc: "古著與雜貨" },
            { day: "Day 3", type: "shopping", name: "raff / Ident / Band", tag: "購物", desc: "二手服飾" },
            { day: "Day 3", type: "food", name: "neel 中崎町", tag: "咖啡", desc: "梨子Logo名店" },
            { day: "Day 3", type: "food", name: "OSA COFFEE", tag: "咖啡", desc: "布丁好吃" },
            { day: "Day 3", type: "shopping", name: "扭蛋之森", tag: "購物", desc: "梅田茶屋町" },
            { day: "Day 3", type: "food", name: "Blue Bottle", tag: "咖啡", desc: "茶屋町店" },
            { day: "Day 3", type: "shopping", name: "Mizuno", tag: "購物", desc: "美津濃旗艦店" },
            { day: "Day 3", type: "food", name: "PALM Cafe", tag: "小吃", desc: "薄餅" },
            { day: "Day 3", type: "shopping", name: "阪急三番街", tag: "購物", desc: "Kiddyland, 吉卜力" },
            { day: "Day 3", type: "food", name: "Crepe De Girafe", tag: "小吃", desc: "長頸鹿可麗餅" },
            { day: "Day 3", type: "food", name: "Grenier", tag: "甜點", desc: "千層酥" },
            { day: "Day 3", type: "shopping", name: "阪急百貨", tag: "購物", desc: "B1伴手禮天堂" },
            { day: "Day 3", type: "food", name: "Hanadako", tag: "晚餐", desc: "新梅田食道街蔥花章魚燒" },
            { day: "Day 3", type: "food", name: "WeLoveDonut", tag: "小吃", desc: "生甜甜圈" },
            { day: "Day 3", type: "shopping", name: "大丸百貨", tag: "購物", desc: "寶可夢, 任天堂" },
            { day: "Day 3", type: "shopping", name: "Kitte", tag: "購物", desc: "各地名產" },
            { day: "Day 3", type: "shopping", name: "LUCUA / 1100", tag: "購物", desc: "Montbell, 雜貨" },
            { day: "Day 3", type: "shopping", name: "無印良品", tag: "購物", desc: "Grand Front Osaka" },
            { day: "Day 3", type: "shopping", name: "LINKS UMEDA", tag: "購物", desc: "宜得利, 大創" },
            { day: "Day 3", type: "shopping", name: "Yodobashi", tag: "購物", desc: "電器, 扭蛋" },

            // Day 4
            { day: "Day 4", type: "attraction", name: "宇治歷史公園", tag: "景點", desc: "茶與宇治之鄉" },
            { day: "Day 4", type: "food", name: "伊藤久右衛門", tag: "午餐", desc: "抹茶咖哩、巴菲" },
            { day: "Day 4", type: "food", name: "函館市場", tag: "午餐", desc: "迴轉壽司" },
            { day: "Day 4", type: "food", name: "つばめ屋", tag: "午餐", desc: "抹茶蕎麥麵" },
            { day: "Day 4", type: "attraction", name: "宇治神社", tag: "景點", desc: "兔子神社" },
            { day: "Day 4", type: "food", name: "星巴克", tag: "咖啡", desc: "平等院表參道" },
            { day: "Day 4", type: "food", name: "宇治洋食屋", tag: "午餐", desc: "咖哩飯" },
            { day: "Day 4", type: "food", name: "京鴨kitchen 善", tag: "午餐", desc: "鴨肉漢堡" },
            { day: "Day 4", type: "food", name: "Food Park", tag: "午餐", desc: "和牛漢堡" },
            { day: "Day 4", type: "food", name: "赤門茶屋", tag: "咖啡", desc: "抹茶啤酒" },
            { day: "Day 4", type: "food", name: "ますだ茶舗", tag: "咖啡", desc: "抹茶冰淇淋" },
            { day: "Day 4", type: "attraction", name: "平等院", tag: "古蹟", desc: "鳳凰堂(10円硬幣)" },
            { day: "Day 4", type: "food", name: "中村藤吉", tag: "甜點", desc: "抹茶凍" },
            { day: "Day 4", type: "food", name: "HOHO HOJICHA", tag: "小吃", desc: "焙茶專賣" },
            { day: "Day 4", type: "shopping", name: "おうすの里", tag: "購物", desc: "梅子專賣" },
            { day: "Day 4", type: "food", name: "大石久右衛門", tag: "咖啡", desc: "抹茶甜點" },
            { day: "Day 4", type: "food", name: "Hariyoshi", tag: "小吃", desc: "可樂餅" },
            { day: "Day 4", type: "food", name: "Good Knight Ice", tag: "甜點", desc: "深夜冰淇淋" },
            { day: "Day 4", type: "food", name: "大佛草莓", tag: "甜點", desc: "草莓大福" },
            { day: "Day 4", type: "food", name: "章魚燒八兵衛", tag: "小吃", desc: "蔥花美乃滋" },
            { day: "Day 4", type: "food", name: "中谷堂", tag: "小吃", desc: "高速搗麻糬" },
            { day: "Day 4", type: "food", name: "Rokumei Coffee", tag: "咖啡", desc: "冠軍咖啡" },
            { day: "Day 4", type: "food", name: "大佛布丁", tag: "甜點", desc: "伴手禮" },
            { day: "Day 4", type: "attraction", name: "春日大社", tag: "景點", desc: "朱紅迴廊" },
            { day: "Day 4", type: "food", name: "水谷茶屋", tag: "咖啡", desc: "茅草屋頂" },
            { day: "Day 4", type: "food", name: "Le Case", tag: "咖啡", desc: "鹹派專門" },
            { day: "Day 4", type: "attraction", name: "若草山", tag: "景點", desc: "休憩所" },
            { day: "Day 4", type: "food", name: "古都屋", tag: "午茶", desc: "天婦羅" },
            { day: "Day 4", type: "attraction", name: "東大寺", tag: "景點", desc: "二月堂、大佛" },
            { day: "Day 4", type: "food", name: "繪馬堂茶屋", tag: "午茶", desc: "烏龍麵" },
            { day: "Day 4", type: "attraction", name: "奈良公園", tag: "景點", desc: "餵鹿" },
            { day: "Day 4", type: "food", name: "TEN.TEN.CAFE", tag: "咖啡", desc: "鬆餅" },
            { day: "Day 4", type: "food", name: "鹿屋", tag: "小吃", desc: "霜淇淋" },
            { day: "Day 4", type: "attraction", name: "冰室神社", tag: "景點", desc: "製冰之神" },
            { day: "Day 4", type: "food", name: "志津香釜飯", tag: "晚餐", desc: "七種食材釜飯" },
            { day: "Day 4", type: "attraction", name: "興福寺", tag: "景點", desc: "五重塔" },
            { day: "Day 4", type: "food", name: "Drink Drank", tag: "小吃", desc: "水果冰沙" },
            { day: "Day 4", type: "food", name: "Nanairo Fruits", tag: "小吃", desc: "草莓可麗餅" },
            { day: "Day 4", type: "food", name: "猿田彥珈琲", tag: "咖啡", desc: "奈良店" },
            { day: "Day 4", type: "shopping", name: "中川政七商店", tag: "購物", desc: "生活雜貨" },
            { day: "Day 4", type: "food", name: "maeda donut", tag: "小吃", desc: "甜甜圈" },
            { day: "Day 4", type: "shopping", name: "大創", tag: "購物", desc: "近鐵奈良店" },
            { day: "Day 4", type: "food", name: "元喜神拉麵", tag: "晚餐", desc: "雞白湯+雜炊" },
            { day: "Day 4", type: "food", name: "釜粋", tag: "晚餐", desc: "烏龍麵" },
            { day: "Day 4", type: "food", name: "GRANCHA", tag: "晚餐", desc: "茶泡飯" },
            { day: "Day 4", type: "food", name: "Takamaya", tag: "晚餐", desc: "蕎麥麵" },
            { day: "Day 4", type: "food", name: "雞soba", tag: "晚餐", desc: "雞白湯拉麵" },
            { day: "Day 4", type: "food", name: "麵屋 侍", tag: "晚餐", desc: "乾拌麵" },

            // Day 5
            { day: "Day 5", type: "food", name: "TEA ROOM Tamy", tag: "早餐", desc: "老派喫茶吐司" },
            { day: "Day 5", type: "attraction", name: "嵐山公園", tag: "景點", desc: "中之島" },
            { day: "Day 5", type: "attraction", name: "渡月橋", tag: "景點", desc: "經典地標" },
            { day: "Day 5", type: "food", name: "新八茶屋", tag: "小吃", desc: "義式冰淇淋" },
            { day: "Day 5", type: "food", name: "湯葉起司", tag: "午餐", desc: "豆皮起司串" },
            { day: "Day 5", type: "food", name: "% ARABICA", tag: "咖啡", desc: "河畔拿鐵" },
            { day: "Day 5", type: "attraction", name: "嵐山屋形船", tag: "景點", desc: "遊船" },
            { day: "Day 5", type: "food", name: "中村屋可樂餅", tag: "小吃", desc: "和牛內餡" },
            { day: "Day 5", type: "food", name: "米菲兔櫻花廚房", tag: "購物", desc: "造型麵包" },
            { day: "Day 5", type: "shopping", name: "昇龍苑", tag: "購物", desc: "伴手禮" },
            { day: "Day 5", type: "shopping", name: "拉拉熊茶房", tag: "購物", desc: "主題餐廳" },
            { day: "Day 5", type: "food", name: "Ozuru 烏龍麵", tag: "午餐", desc: "自家製麵" },
            { day: "Day 5", type: "food", name: "松ヶ枝", tag: "午餐", desc: "豆腐料理" },
            { day: "Day 5", type: "food", name: "嵐山よしむら", tag: "午餐", desc: "蕎麥麵" },
            { day: "Day 5", type: "attraction", name: "天龍寺", tag: "景點", desc: "曹源池庭園" },
            { day: "Day 5", type: "food", name: "嵯峨野湯豆腐", tag: "午餐", desc: "精緻料理" },
            { day: "Day 5", type: "attraction", name: "竹林小徑", tag: "景點", desc: "竹林" },
            { day: "Day 5", type: "attraction", name: "大河內山莊", tag: "景點", desc: "庭園" },
            { day: "Day 5", type: "attraction", name: "御髮神社", tag: "景點", desc: "美髮之神" },
            { day: "Day 5", type: "attraction", name: "常寂光寺", tag: "景點", desc: "綠意" },
            { day: "Day 5", type: "food", name: "Ogura茶屋", tag: "午餐", desc: "烏龍麵" },
            { day: "Day 5", type: "food", name: "NONO", tag: "咖啡", desc: "拿鐵" },
            { day: "Day 5", type: "food", name: "団五郎", tag: "午餐", desc: "蕎麥麵" },
            { day: "Day 5", type: "attraction", name: "野宮神社", tag: "景點", desc: "締結良緣" },
            { day: "Day 5", type: "food", name: "鯛匠 HANANA", tag: "午餐", desc: "鯛魚茶泡飯" },
            { day: "Day 5", type: "food", name: "京豆庵", tag: "小吃", desc: "豆腐冰淇淋" },
            { day: "Day 5", type: "food", name: "古都芋本舖", tag: "小吃", desc: "大支烤糰子" },
            { day: "Day 5", type: "food", name: "上島珈琲店", tag: "咖啡", desc: "休息推薦" },
            { day: "Day 5", type: "food", name: "雲之茶", tag: "咖啡", desc: "雲朵慕斯" },
            { day: "Day 5", type: "food", name: "金之華", tag: "小吃", desc: "蒙布朗" },
            { day: "Day 5", type: "food", name: "Cafe 嵯峨野湯", tag: "午餐", desc: "澡堂改建" },
            { day: "Day 5", type: "attraction", name: "嵐山站足湯", tag: "景點", desc: "放鬆" },
            { day: "Day 5", type: "attraction", name: "友禪的光林", tag: "景點", desc: "裝置藝術" },
            { day: "Day 5", type: "food", name: "Malebranche", tag: "購物", desc: "茶之菓" },
            { day: "Day 5", type: "food", name: "八十八良葉舍", tag: "咖啡", desc: "抹茶拿鐵" },
            { day: "Day 5", type: "food", name: "えんまん餅店", tag: "咖啡", desc: "抹茶刨冰" },
            { day: "Day 5", type: "food", name: "eX cafe", tag: "咖啡", desc: "烤糰子" },
            { day: "Day 5", type: "shopping", name: "MEGA唐吉軻德", tag: "購物", desc: "新世界店" },
            { day: "Day 5", type: "food", name: "串炸弁慶", tag: "宵夜", desc: "通天閣旁" },
            { day: "Day 5", type: "attraction", name: "通天閣", tag: "景點", desc: "地標" },

            { day: "Day 6", type: "food", name: "新世界通天閣 喫茶", tag: "早餐", desc: "玉子三明治" },
            { day: "Day 6", type: "attraction", name: "今宮戎神社", tag: "景點", desc: "金箔御守" },
            { day: "Day 6", type: "food", name: "Mainichi 喫茶", tag: "早餐", desc: "早午餐" },
            { day: "Day 6", type: "food", name: "木津市場", tag: "早餐", desc: "海鮮丼" },
            { day: "Day 6", type: "food", name: "Kaino Coffee", tag: "早餐", desc: "市場咖啡" },
            { day: "Day 6", type: "food", name: "にく笑", tag: "早餐", desc: "定食" },
            { day: "Day 6", type: "attraction", name: "難波八阪神社", tag: "景點", desc: "獅子殿" },
            { day: "Day 6", type: "food", name: "AUN COFFEE", tag: "咖啡", desc: "手沖" },
            { day: "Day 6", type: "food", name: "HARBS", tag: "甜點", desc: "Namba Parks 水果千層" },
            { day: "Day 6", type: "food", name: "P.G.donut", tag: "甜點", desc: "生甜甜圈" },
            { day: "Day 6", type: "shopping", name: "Namba Parks", tag: "購物", desc: "戶外用品" },
            { day: "Day 6", type: "shopping", name: "Namba City", tag: "購物", desc: "無印良品" },
            { day: "Day 6", type: "shopping", name: "Namba Walk", tag: "小吃", desc: "Beard Papa" },
            { day: "Day 6", type: "shopping", name: "難波丸井", tag: "購物", desc: "Uniqlo, GU" },
            { day: "Day 6", type: "shopping", name: "大國藥妝", tag: "購物", desc: "難波" },
            { day: "Day 6", type: "food", name: "天婦羅 Makino", tag: "小吃", desc: "現炸" },
            { day: "Day 6", type: "shopping", name: "Bic Camera", tag: "購物", desc: "電器" },
            { day: "Day 6", type: "food", name: "Strawberry Mania", tag: "小吃", desc: "草莓" },
            { day: "Day 6", type: "food", name: "Hirota", tag: "小吃", desc: "泡芙" },
            { day: "Day 6", type: "food", name: "作之作拉麵", tag: "晚餐", desc: "千日前" },
            { day: "Day 6", type: "food", name: "章魚燒道樂 Wanaka", tag: "小吃", desc: "道頓堀" },
            { day: "Day 6", type: "food", name: "龜王拉麵", tag: "晚餐", desc: "道頓堀" },
            { day: "Day 6", type: "food", name: "Hayashida", tag: "晚餐", desc: "拉麵" },
            { day: "Day 6", type: "attraction", name: "固力果跑跑人", tag: "景點", desc: "戎橋" },
            { day: "Day 6", type: "food", name: "吉次燒肉", tag: "晚餐", desc: "厚切牛舌" },
            { day: "Day 6", type: "food", name: "Susuruka", tag: "晚餐", desc: "麻婆豆腐麵" },
            { day: "Day 6", type: "food", name: "鈍屋拉麵", tag: "晚餐", desc: "心齋橋" },
            { day: "Day 6", type: "food", name: "PABLO", tag: "甜點", desc: "起司塔" },
            { day: "Day 6", type: "food", name: "MooKEN", tag: "小吃", desc: "泡芙" },
            { day: "Day 6", type: "food", name: "大阪燒 千房", tag: "宵夜", desc: "心齋橋" },
            { day: "Day 6", type: "shopping", name: "大丸百貨", tag: "購物", desc: "寶可夢中心" },
            { day: "Day 6", type: "shopping", name: "PARCO", tag: "購物", desc: "動漫" },
            { day: "Day 6", type: "food", name: "一蘭拉麵", tag: "宵夜", desc: "心齋橋" },
            { day: "Day 6", type: "food", name: "LiLo Coffee", tag: "咖啡", desc: "手沖" },
            { day: "Day 6", type: "food", name: "鳴門鯛燒本舖", tag: "小吃", desc: "鯛魚燒" },

            { day: "Day 7", type: "shopping", name: "Rinku Outlet", tag: "購物", desc: "最後血拼" },
            { day: "Day 7", type: "food", name: "麥當勞", tag: "午餐", desc: "Outlet" },
            { day: "Day 7", type: "food", name: "Panda Express", tag: "午餐", desc: "美式中餐" },
            { day: "Day 7", type: "attraction", name: "Love Rinku", tag: "景點", desc: "拍照" },
            { day: "Day 7", type: "food", name: "神座拉麵", tag: "晚餐", desc: "機場" },
            { day: "Day 7", type: "food", name: "551蓬萊", tag: "晚餐", desc: "肉包" }
        ];

        let currentDay = "2026-06-06";
        let currentItems = [];
        let currentExpenses = [];
        let activeSortable = null;
        let tripData = null;
        let db = null;
        let isOnline = false;

        // DOM Elements for Modal (v15.1 Fix: Defined globally)
        let editModal, editModalContent;

        document.addEventListener('DOMContentLoaded', async () => {
            // v15.1 Fix: Initialize Modal Elements after DOM Ready
            editModal = document.getElementById('edit-modal');
            editModalContent = document.getElementById('modal-content');

            loadLocalData();
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isOnline = true;
                updateConnectionStatus(true);
                setupFirestoreListener();
            } catch (e) {
                console.warn("Firebase Init Failed:", e);
                updateConnectionStatus(false);
            }
            
            // Initial Renders
            renderChecklist();
            renderDayNav();
            renderTimeline(currentDay);
            renderSpots('all');
            startJapanClock();
            startCountdown();
            
            // Global functions setup
            window.openEditModal = openEditModal;
            window.closeEditModal = closeEditModal;
            window.saveItem = saveItem;
            window.deleteItem = deleteItem;
            window.addExpense = addExpense;
            window.deleteExpense = deleteExpense;
            window.resetExpenses = resetExpenses;
            window.filterSpots = filterSpots;
            window.switchTab = switchTab;
        });

        function updateConnectionStatus(online) {
            const statusEl = document.getElementById('connection-status');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            statusEl.classList.remove('hidden');
            if (online) {
                dot.className = 'status-dot status-online';
                text.innerText = 'Cloud';
            } else {
                dot.className = 'status-dot status-offline';
                text.innerText = 'Local';
            }
        }

        function loadLocalData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { tripData = JSON.parse(saved); } 
                catch(e) { tripData = defaultTripData; }
            } else {
                tripData = defaultTripData;
            }
        }

        function setupFirestoreListener() {
            db.collection("jptrip_2026").doc("itinerary").onSnapshot((doc) => {
                if (doc.exists) {
                    tripData = doc.data().days;
                    renderTimeline(currentDay);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(tripData));
                } else {
                    saveData(true);
                }
            });
        }

        function saveData(forceCloud = false) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tripData));
            if (isOnline || forceCloud) {
                db.collection("jptrip_2026").doc("itinerary").set({ days: tripData }).catch(console.error);
            }
        }

        function startJapanClock() {
            const updateTime = () => {
                const now = new Date();
                const japanTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
                const hours = String(japanTime.getHours()).padStart(2, '0');
                const minutes = String(japanTime.getMinutes()).padStart(2, '0');
                const el = document.getElementById('japan-clock');
                if(el) el.innerText = `${hours}:${minutes}`;
            };
            updateTime(); setInterval(updateTime, 1000);
        }

        function startCountdown() {
            const targetDate = new Date("2026-06-06T00:00:00").getTime();
            const update = () => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                const el = document.getElementById("countdown-timer");
                if (!el) return;
                
                if (distance < 0) {
                    el.innerHTML = "<div class='w-full text-center text-rose-600 font-bold'>TRIP STARTED!</div>";
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                el.innerHTML = `
                    <div class="text-center"><span class="timer-digit">${days}</span><div class="timer-label">DAYS</div></div>
                    <div class="text-2xl text-stone-300 self-center pb-4">:</div>
                    <div class="text-center"><span class="timer-digit">${String(hours).padStart(2,'0')}</span><div class="timer-label">HRS</div></div>
                    <div class="text-2xl text-stone-300 self-center pb-4">:</div>
                    <div class="text-center"><span class="timer-digit">${String(minutes).padStart(2,'0')}</span><div class="timer-label">MIN</div></div>
                    <div class="text-2xl text-stone-300 self-center pb-4">:</div>
                    <div class="text-center"><span class="timer-digit">${String(seconds).padStart(2,'0')}</span><div class="timer-label">SEC</div></div>
                `;
            };
            update(); setInterval(update, 1000);
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            if(!container) return;
            container.innerHTML = checklistData.map(cat => `
                <div class="glass-card rounded-xl p-4">
                    <h3 class="font-bold text-stone-700 mb-3 border-b border-stone-200 pb-2 serif">${cat.title}</h3>
                    <div class="space-y-2">
                        ${cat.items.map(item => `
                            <label class="flex items-start cursor-pointer group hover:bg-white/50 p-1 rounded transition">
                                <input type="checkbox" class="accent-rose-600 w-4 h-4 mt-0.5 mr-2">
                                <span class="text-sm text-stone-600 group-hover:text-stone-800 transition">${item}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`).join('');
        }

        function renderDayNav() {
            if (!tripData) return;
            const sortedKeys = Object.keys(tripData).sort();
            const container = document.getElementById('day-nav');
            if(!container) return;
            
            container.innerHTML = sortedKeys.map((date, i) => {
                const active = date === currentDay;
                return `<button type="button" onclick="switchTab('itinerary', event); selectDay('${date}')" class="shrink-0 px-4 py-2 rounded-lg border transition-all ${active ? 'bg-stone-800 text-white border-stone-800 shadow-md' : 'bg-white/80 text-stone-600 border-stone-200 hover:bg-white'}">
                    <div class="text-[10px] uppercase opacity-70">Day ${i+1}</div>
                    <div class="text-sm font-bold whitespace-nowrap">${tripData[date].dateDisplay}</div>
                </button>`;
            }).join('');
        }

        function selectDay(date) {
            currentDay = date;
            renderDayNav();
            renderTimeline(date);
        }

        function renderTimeline(date) {
            if (!tripData) return;
            const data = tripData[date];
            currentItems = data.items;
            currentExpenses = data.expenses || [];
            
            const tipEl = document.getElementById('daily-tip');
            const weatherEl = document.getElementById('weather-display');
            if(tipEl) tipEl.innerText = data.tip;
            if(weatherEl) weatherEl.innerText = data.weather;

            const list = document.getElementById('timeline-list');
            if(!list) return;
            list.innerHTML = '';
            
            currentItems.forEach(item => {
                const el = document.createElement('div');
                el.className = 'glass-card rounded-xl p-4 relative hover-scale cursor-pointer active:scale-[0.99] bg-white/80';
                // v16.1 Fix: Direct handler with event propagation check
                el.onclick = (e) => { 
                    // Prevent edit if clicking link or drag handle
                    if(e.target.tagName !== 'A' && !el.classList.contains('sortable-drag')) {
                        openEditModal(item.id); 
                    }
                };
                
                let typeIcon = {'food':'🍽️','shop':'🛍️','spot':'⛩️','transport':'🚇'}[item.type] || '💤';
                let typeColor = {'food':'text-orange-600 bg-orange-50','shop':'text-pink-600 bg-pink-50','spot':'text-blue-600 bg-blue-50','transport':'text-stone-600 bg-stone-100'}[item.type] || 'text-gray-600 bg-gray-100';
                let mapBtn = item.mapUrl ? `<div class="mt-3 pt-2 border-t border-stone-100"><a href="${item.mapUrl}" target="_blank" class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-full hover:bg-blue-100 transition font-bold" onclick="event.stopPropagation()">📍 導航</a></div>` : '';

                el.innerHTML = `<div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><span class="font-mono font-bold text-lg text-stone-700">${item.time}</span><span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${typeColor}">${typeIcon}</span></div></div><h3 class="font-bold text-lg text-stone-800 leading-tight">${item.title}</h3><p class="text-xs text-stone-500 truncate mt-1">${item.desc}</p>${mapBtn}`;
                list.appendChild(el);
            });

            if (activeSortable) activeSortable.destroy();
            activeSortable = new Sortable(list, {
                animation: 150, delay: 200, delayOnTouchOnly: true,
                onEnd: (evt) => {
                    const moved = currentItems.splice(evt.oldIndex, 1)[0];
                    currentItems.splice(evt.newIndex, 0, moved);
                    saveData();
                }
            });
            renderExpenses();
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            if(!list) return;
            list.innerHTML = currentExpenses.map((exp, index) => `<li class="flex justify-between items-center bg-white/50 p-2 rounded border border-stone-100"><span>${exp.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold text-stone-700">¥${exp.cost}</span><button type="button" onclick="deleteExpense(${index})" class="text-stone-300 hover:text-red-500">×</button></div></li>`).join('');
            const total = currentExpenses.reduce((sum, item) => sum + parseInt(item.cost), 0);
            const totalEl = document.getElementById('expense-total');
            if(totalEl) totalEl.innerText = `¥${total.toLocaleString()}`;
        }

        function addExpense(e) {
            e.preventDefault();
            const name = document.getElementById('new-expense-name').value;
            const cost = document.getElementById('new-expense-cost').value;
            if(name && cost) {
                if(!tripData[currentDay].expenses) tripData[currentDay].expenses = [];
                tripData[currentDay].expenses.push({name, cost: parseInt(cost)});
                document.getElementById('new-expense-name').value = '';
                document.getElementById('new-expense-cost').value = '';
                saveData(); renderExpenses();
            }
        }

        function deleteExpense(index) {
            tripData[currentDay].expenses.splice(index, 1);
            saveData(); renderExpenses();
        }

        function resetExpenses() {
            if(confirm("確定清空本日帳目？")) {
                tripData[currentDay].expenses = [];
                saveData(); renderExpenses();
            }
        }

        // v16.2: Render Spots with Smart Sorting
        const tagOrder = {
            "早餐": 1, "早午餐": 2,
            "午餐": 3,
            "下午茶": 4, "午茶": 4, "甜點": 4, "咖啡": 4, "飲品": 4,
            "晚餐": 5,
            "宵夜": 6,
            "小吃": 7,
            "購物": 8, "伴手禮": 8, "藥妝": 8, "百貨": 8, "Outlet": 8,
            "景點": 9, "神社": 9, "寺廟": 9, "古蹟": 9,
            "機場": 10, "交通": 10, "其他": 11
        };

        function getSortOrder(tag) {
            // Simple check for keyword inclusion
            for (let key in tagOrder) {
                if (tag && tag.includes(key)) return tagOrder[key];
            }
            return 99; // Default low priority
        }

        function renderSpots(filter = 'all') {
            const container = document.getElementById('spots-container');
            if(!container) return;
            
            // Filter
            let filteredSpots = allSpots.filter(s => filter === 'all' || s.day === filter);
            
            // v16.2: Sort by Tag Priority
            filteredSpots.sort((a, b) => {
                return getSortOrder(a.tag) - getSortOrder(b.tag);
            });

            container.innerHTML = filteredSpots.map(spot => {
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.name + ' ' + spot.tag + ' 大阪')}`;
                
                let typeBadge = '';
                switch(spot.type) {
                    case 'food': typeBadge = `<span class="tag tag-food">🍽️ ${spot.tag}</span>`; break;
                    case 'shopping': typeBadge = `<span class="tag tag-shop">🛍️ ${spot.tag}</span>`; break;
                    case 'attraction': typeBadge = `<span class="tag tag-spot">⛩️ ${spot.tag}</span>`; break;
                    case 'drink': typeBadge = `<span class="tag tag-drink">☕ ${spot.tag}</span>`; break;
                    default: typeBadge = `<span class="tag bg-gray-100 text-gray-600">📍 ${spot.tag}</span>`;
                }

                return `
                <a href="${mapLink}" target="_blank" class="block glass-card rounded-xl p-4 hover-scale relative overflow-hidden bg-white/80 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-stone-800 text-white">${spot.day}</span>
                    </div>
                    <div class="mb-1">${typeBadge}</div>
                    <h4 class="font-bold text-stone-800 text-base mb-1 line-clamp-1">${spot.name}</h4>
                    <p class="text-xs text-stone-500 mb-3 line-clamp-2 h-8 leading-relaxed">${spot.desc}</p>
                    <div class="text-[10px] text-rose-600 font-bold flex items-center gap-1 mt-auto pt-2 border-t border-stone-100">
                        <span>📍</span> Google Map 導航
                    </div>
                </a>
            `}).join('');
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.textContent === (filter === 'all' ? '全部' : filter);
                btn.className = `filter-btn px-4 py-1.5 rounded-full text-sm font-bold transition ${isActive ? 'bg-stone-800 text-white shadow-lg' : 'bg-white/50 text-stone-600 hover:bg-white'}`;
            });
        }

        function filterSpots(day) { renderSpots(day); }

        // v16.1 Fix: Added event param to prevent default behavior & Removed smooth scroll
        function switchTab(tab, event) {
            if(event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tab}-view`).classList.remove('hidden');
            
            // v22 Fix: Selector changed from '.nav-btn' to '.nav-item' to correctly remove active class
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
                // Removed the manual color class manipulation as CSS handles it better based on .active
            });
            
            const activeBtn = document.getElementById(`btn-${tab}`);
            if(activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // v16.1 Fix: Instant scroll to avoid "refresh-like" jump
            window.scrollTo(0, 0);
        }

        // Modal Logic (v15.1 Fix)
        let editingId = null;

        function openEditModal(id = null) {
            const editModal = document.getElementById('edit-modal');
            const editModalContent = document.getElementById('modal-content');
            
            if(!editModal || !editModalContent) {
                console.error("Modal elements not found");
                return;
            }

            editingId = id;
            document.getElementById('edit-form').reset();
            document.getElementById('modal-title').innerText = id ? '編輯行程' : '新增行程';
            
            if(id) {
                const item = currentItems.find(i => i.id === id);
                if(item) {
                    document.getElementById('edit-time').value = item.time || "";
                    document.getElementById('edit-type').value = item.type || "other";
                    document.getElementById('edit-name').value = item.title || "";
                    document.getElementById('edit-map').value = item.mapUrl || "";
                    document.getElementById('edit-desc').value = item.desc || "";
                }
            }
            
            editModal.classList.remove('hidden');
            setTimeout(() => editModalContent.classList.remove('translate-y-full'), 10);
        }

        function closeEditModal() {
            const editModal = document.getElementById('edit-modal');
            const editModalContent = document.getElementById('modal-content');
            if(editModalContent) editModalContent.classList.add('translate-y-full');
            setTimeout(() => {
                if(editModal) editModal.classList.add('hidden');
            }, 300);
        }

        function saveItem() {
            const newItem = {
                id: editingId || Date.now().toString(),
                time: document.getElementById('edit-time').value || "00:00",
                type: document.getElementById('edit-type').value,
                title: document.getElementById('edit-name').value,
                mapUrl: document.getElementById('edit-map').value,
                desc: document.getElementById('edit-desc').value
            };

            if(editingId) {
                const idx = currentItems.findIndex(i => i.id === editingId);
                if(idx !== -1) currentItems[idx] = newItem;
            } else {
                currentItems.push(newItem);
                currentItems.sort((a, b) => a.time.localeCompare(b.time));
            }
            renderTimeline(currentDay);
            saveData();
            closeEditModal();
        }

        function deleteItem() {
            if(editingId && confirm('確定刪除?')) {
                currentItems = currentItems.filter(i => i.id !== editingId);
                tripData[currentDay].items = currentItems;
                renderTimeline(currentDay);
                saveData();
                closeEditModal();
            }
        }
    </script>
</body>
</html>